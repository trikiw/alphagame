<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>

  <script src="fengari-web.js" type="text/javascript"></script>

  <script>

  class Pet {
    constructor() {
      let config = {
        canvas: 'canvas',
        sprites: 'sprites',
        font: 'font',
        width: 320,
        height: 240,
        cwid: 640,
        chgt: 480,
      };
      this.width = config.width;
      this.height = config.height;
      this.cwid = config.cwid;
      this.chgt = config.chgt;
      this.padtime = [];
      this.playimgs = [];
      this.pad2btn = [];
      this.btnactive = [];
      this.paddown = [];
      this.keydown = [];
      this.btn = [];
      this.pbtn = [];
      this.sprites = document.querySelector('#'+config.sprites);
      this.font = document.querySelector('#'+config.font);
      this.canvas = document.querySelector('#'+config.canvas);
      this.cctx = this.canvas.getContext('2d');
      this.cctx.imageSmoothingEnabled = false;
      this.cctx.globalCompositeOperation = 'copy';
      this.screen = document.createElement('canvas');
      this.screen.width = config.width;
      this.screen.height = config.height;
      this.sctx = this.screen.getContext('2d');
      this.sctx.imageSmoothingEnabled = false;
      this.draft = document.createElement('canvas');
      this.draft.width = config.width;
      this.draft.height = config.height;
      this.dctx = this.draft.getContext('2d');
      this.dctx.imageSmoothingEnabled = false;
      let a = [
        0,'a',0x4a,595,306,
        1,'b',0x4b,612,306,
        2,'x',0x55,765,323,
        3,'y',0x49,782,323,
        12,'up',0x45,391,340,
        13,'down',0x44,425,340,
        14,'left',0x53,442,340,
        15,'right',0x46,408,340,
        8,'select',0x31,51,374,
        9,'start',0x32,68,374,
        //-1,'play',27,0,374,
      ];
      let key2pad = [],btn2pad = {};
      let mousedown = (e)=>this.padDown(btn2pad[e.target.getAttribute('id')],true);
      let mouseup = (e)=>this.padDown(btn2pad[e.target.id],false);
      for(let i = 0; i < a.length; i += 5) {
        key2pad[a[i+2]] = a[i];
        btn2pad[a[i+1]] = a[i];
        this.pad2btn[a[i]] = a[i+1];
        let e = document.querySelector('#'+a[i+1]);
        e.addEventListener('mousedown',mousedown);
        e.addEventListener('mouseup',mouseup);
        let c = document.createElement('canvas');
        c.width = c.height = 16;
        c.getContext('2d').drawImage(this.sprites,a[i+3],a[i+4],16,16,0,0,16,16);
        e.appendChild(c);
        if(a[i] == -1) this.playimgs.push(c);
      }
      let c = document.createElement('canvas');
      c.width = c.height = 16;
      c.getContext('2d').drawImage(this.sprites,17,374,16,16,0,0,16,16);
      this.playimgs.push(c);
      document.addEventListener('keydown',(e)=>this.keyDown(key2pad[e.which],true));
      document.addEventListener('keyup',(e)=>this.keyDown(key2pad[e.which],false));
    }

    show() {
      this.cctx.drawImage(this.screen,0,0,this.width,this.height,0,0,this.cwid,this.chgt);
    }

    update() {
      this.btn = [];
      this.pbtn = [];
      let t = Date.now();
      if(navigator.getGamepads && navigator.getGamepads()[0])
      navigator.getGamepads()[0].buttons.forEach((v, i) => {
        if(v.pressed) {
          if(!this.paddown[i]) {
            this.paddown[i] = true;
            this.padDown(i,true);
          }
        } else if(this.paddown[i]) {
          this.paddown[i] = false;
          this.padDown(i,false);
        }
      });
      else
      this.paddown.forEach((v, i) => {
        if(v) {
          this.paddown[i] = false;
          this.padDown(i,false);
        }
      });
      this.btnactive.forEach((v, i) => {
        if(v) {
          this.btn[i] = true;
          if(!this.padtime[i]) {
            this.padtime[i] = t+384;
            this.pbtn[i] = true;
          } else if(this.padtime[i] < t) {
            this.padtime[i] = t+28;
            this.pbtn[i] = true;
          }
        } else
        this.padtime[i] = null;
      });
    }

    play() {
      document.querySelector('#play').classList.toggle('hide',true);
      document.querySelector('#restart').classList.toggle('hide',true);
      document.querySelector('#new').classList.toggle('hide',true);
      document.querySelector('#pause').classList.toggle('hide',false);
      this.thread = setInterval(()=>{
        try {
          this.run();
        } catch(err) {
          pause();
          alert(err.toString());
        }
      },17);
    }

    pause() {
      document.querySelector('#play').classList.toggle('hide',false);
      document.querySelector('#restart').classList.toggle('hide',false);
      document.querySelector('#new').classList.toggle('hide',false);
      document.querySelector('#pause').classList.toggle('hide',true);
      clearInterval(this.thread);
      this.thread = null;
    }

    async start(b) {
      if(b || !this.file) {
        this.file = (await window.showOpenFilePicker())[0];
        document.querySelector('#program').innerText = this.file.name;
      }
      let f = await this.file.getFile();
      try {
        fengari.load(await f.text())();
        this.run = fengari.load('pet:update() if _update then _update() end if _draw then _draw() pet:show() end');
        fengari.load('pet=js.global.pet if _init then _init() pet:show() end')();
      } catch(err) {
        alert(err.toString());
      }
      if(fengari.load('return (_update or _draw) and true')()) {
        pet.play();
      } else {
        document.querySelector('#play').classList.toggle('hide',true);
        document.querySelector('#restart').classList.toggle('hide',false);
        document.querySelector('#new').classList.toggle('hide',false);
        document.querySelector('#pause').classList.toggle('hide',true);
      }
    }

    keyDown(n,b) {
      if(n === undefined) return;
      if(b && this.keydown[n]) return;
      this.keydown[n] = b;
      this.padDown(n,b);
    }

    padDown(n,b) {
      if(n === undefined) return;
      if(b)
      if(!this.btnactive[n]) {
        this.btnactive[n] = 1;
        document.querySelector('#'+this.pad2btn[n]).classList.toggle('btn-active',true);
        if(n == -1) this.play();
      } else
      this.btnactive[n]++;
      else {
        if(!--this.btnactive[n])
        document.querySelector('#'+this.pad2btn[n]).classList.toggle('btn-active',false);
      }
    }

    dline(x0,y0,x1,y1,color,op) {
      x0 = Math.floor(x0);
      y0 = Math.floor(y0);
      x1 = Math.floor(x1);
      y1 = Math.floor(y1);
      let dx = Math.abs(x1-x0);
      let sx = x0 < x1? 1:-1;
      let dy = -Math.abs(y1-y0);
      let sy = y0 < y1? 1:-1;
      let err = dx+dy;
      this.sctx.save();
      this.sctx.beginPath();
      for(;;) {
        this.sctx.rect(x0,y0,1,1);
        if(x0 == x1 && y0 == y1) break;
        let e2 = 2*err;
        if(e2 >= dy) {
          err += dy;
          x0 += sx;
        }
        if(e2 <= dx) {
          err += dx;
          y0 += sy;
        }
      }
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.fillStyle = color;
      this.sctx.fill();
      this.sctx.restore();
    }

    dcircle(x0,y0,r,color,op) {
      x0 = Math.floor(x0);
      y0 = Math.floor(y0);
      r = Math.floor(r);
      let x = 0,y = r;
      let d = 3-2*r;
      this.sctx.save();
      this.sctx.beginPath();
      for(;;) {
        this.sctx.rect(x0+x,y0+y,1,1);
        this.sctx.rect(x0-x,y0+y,1,1);
        this.sctx.rect(x0+x,y0-y,1,1);
        this.sctx.rect(x0-x,y0-y,1,1);
        this.sctx.rect(x0+y,y0+x,1,1);
        this.sctx.rect(x0-y,y0+x,1,1);
        this.sctx.rect(x0+y,y0-x,1,1);
        this.sctx.rect(x0-y,y0-x,1,1);
        if(y < x) break;
        x++;
        if(d > 0) {
          y--;
          d += 4*(x-y)+10;
        } else
        d += 4*x+6;
      }
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.fillStyle = color;
      this.sctx.fill();
      this.sctx.restore();
    }

    fcircle(x0,y0,r,color,op) {
      x0 = Math.floor(x0);
      y0 = Math.floor(y0);
      r = Math.floor(r);
      let x = 0,y = r;
      let d = 3-2*r;
      let x1 = x,y1 = y;
      this.sctx.save();
      this.sctx.beginPath();
      for(;;) {
        this.sctx.rect(x0+x,y0-y,1,2*y+1);
        this.sctx.rect(x0-x,y0-y,1,2*y+1);
        if(y < y1) {
          this.sctx.rect(x0+y1,y0-x1,1,2*x1+1);
          this.sctx.rect(x0-y1,y0-x1,1,2*x1+1);
        }
        x1 = x; y1 = y;
        if(y < x) break;
        x++;
        if(d > 0) {
          y--;
          d += 4*(x-y)+10;
        } else
        d += 4*x+6;
      }
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.fillStyle = color;
      this.sctx.fill();
      this.sctx.restore();
    }

    drect(x0,y0,wid,hgt,color,op) {
      x0 = Math.floor(x0);
      y0 = Math.floor(y0);
      wid = Math.floor(wid);
      hgt = Math.floor(hgt);
      this.sctx.save();
      this.sctx.beginPath();
      this.sctx.rect(x0,y0,wid,1);
      this.sctx.rect(x0,y0+hgt-1,wid,1);
      this.sctx.rect(x0,y0+1,1,hgt-2);
      this.sctx.rect(x0+wid-1,y0+1,1,hgt-2);
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.fillStyle = color;
      this.sctx.fill();
      this.sctx.restore();
    }

    frect(x0,y0,wid,hgt,color,op) {
      this.sctx.save();
      this.sctx.beginPath();
      this.sctx.rect(Math.floor(x0),Math.floor(y0),Math.floor(wid),Math.floor(hgt));
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.fillStyle = color;
      this.sctx.fill();
      this.sctx.restore();
    }

    dsprite(a,b,x,y,color,rot,op) {
      if(!rot) rot = 0;
      this.dctx.globalCompositeOperation = 'copy';
      this.dctx.fillStyle = color;
      this.dctx.fillRect(0,0,16,16);
      this.dctx.globalCompositeOperation = 'destination-in';
      this.dctx.drawImage(sprites,a,b,16,16,0,0,16,16);
      this.sctx.save();
      switch(rot&3) {
        case 1: this.sctx.rotate(Math.PI*.5); [x,y] = [y,-x-16]; break;
        case 2: this.sctx.rotate(Math.PI); [x,y] = [-x-16,-y-16]; break;
        case 3: this.sctx.rotate(Math.PI*-.5); [x,y] = [-y-16,x]; break;
      }
      if(rot&4) { this.sctx.scale(-1,1); x = -x-16; }
      this.sctx.beginPath();
      this.sctx.rect(x,y,16,16);
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.drawImage(this.draft,0,0,16,16,x,y,16,16);
      this.sctx.restore();
    }

    dstring(s,x,y,color,rot,op) {
      if(!rot) rot = 0;
      if(2<=rot && rot<=5 && s.length > 40) s = s.substring(s.length-40);
      let w = s.length*8;
      this.dctx.globalCompositeOperation = 'copy';
      this.dctx.fillStyle = color;
      this.dctx.fillRect(0,0,w,8);
      this.dctx.globalCompositeOperation = 'destination-in';
      for(let i = 0; i < s.length; i++) {
        let a,b = s.charCodeAt(i);
        if(b < 0xa0)
        a = Math.floor((b-0x20)/16);
        else if(b < 0x2500)
        a = 6+Math.floor((b-0xa0)/16);
        else if(b < 0xe000)
        a = 12+Math.floor((b-0x2500)/16);
        else
        a = 28+Math.floor((b-0xe000)/16);
        a = a*8; b = b%16*8;
        this.dctx.save();
        this.dctx.beginPath();
        this.dctx.rect(8*i,0,8,8);
        this.dctx.clip();
        this.dctx.drawImage(this.font,a,b,8,8,8*i,0,8,8);
        this.dctx.restore();
      }
      this.sctx.save();
      switch(rot&3) {
        case 1: this.sctx.rotate(Math.PI*.5); [x,y] = [y,-x-8]; break;
        case 2: this.sctx.rotate(Math.PI); [x,y] = [-x-w,-y-8]; break;
        case 3: this.sctx.rotate(Math.PI*-.5); [x,y] = [-y-w,x]; break;
      }
      if(rot&4) { this.sctx.scale(-1,1); x = -x-w; }
      this.sctx.beginPath();
      this.sctx.rect(x,y,w,8);
      this.sctx.clip();
      this.sctx.globalCompositeOperation = op? op:'source-over';
      this.sctx.drawImage(this.draft,0,0,w,8,x,y,w,8);
      this.sctx.restore();
    }
  }

  var pet;

  function onLoad() {
    pet = new Pet();
  }

  async function runFile() {
    if(!this.fileHandle) {
      [this.fileHandle] = await window.showOpenFilePicker();
    }
    pet.load(await (await fileHandle.getFile()).text());
  }
  /*
  var angle;

  function _init() {
  angle = 0;
}

function _update() {
angle += .1;
if(pet.pbtn[0]) console.log('A');
}

function _draw() {
pet.frect(0,0,320,240,'red','copy');
pet.dline(0,0,239,239,'green');
pet.frect(100,0,100,239,'black');
pet.dsprite(238,340,160+100*Math.cos(angle)-8,120+100*Math.sin(angle)-8,'blue',null,'blue');
}
*/
</script>
<script src='life.js'></script>
<style>

body {
  background: #eeeeee;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#board {
  position: relative;
  display: flex;
  justify-content: space-between;
  max-width: 800px;
  margin: auto;
  background: #fdefb2;
  padding: 2px;
}

.btn-group {
  display: inline-flex;
  flex-direction: column;
  justify-content: center;
}

.btn {
  width: 45px;
  height: 45px;
  margin: 7px;
  background: #c5c6d0;
}

.btn>canvas {
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.btn-active {
  background: #adadc9;
}

#canvas {
  background: white;
  padding: 2px;
}

#select {
  position: absolute;
  right: 0;
  top: 0;
}

#start {
  position: absolute;
  right: 0;
  bottom: 0;
}

#sel-group {
  display: flex;
  align-items: baseline;
  font-family: sans-serif;
  font-size: 14px;
}

.hide {
  display: none;
}

.sel {
  background: green;
  padding: 5px;
  margin: 5px;
}

.sel:hover {
  background: blue;
}

.sel:active {
  background: red;
}

</style>
</head>
<body onload='onLoad()'>
  <div id='sel-group'style='display:flex'>
    <div id='play' class='sel hide' onclick='pet.play()'>play</div>
    <div id='pause' class='sel hide' onclick='pet.pause()'>pause</div>
    <div id='program'></div>
    <div id='restart' class='sel hide' onclick='pet.start(false)'>run</div>
    <div id='new' class='sel' onclick='pet.start(true)'>new</div>
  </div>
  <div id='board'>
    <div class='btn-group'>
      <div id='up' class='btn'></div>
      <div id='down' class='btn'></div>
      <div id='left' class='btn'></div>
      <div id='right' class='btn'></div>
    </div>
    <canvas id='canvas' width=640 height=480></canvas>
    <div class='btn-group'>
      <div id='a' class='btn'></div>
      <div id='b' class='btn'></div>
      <div id='x' class='btn'></div>
      <div id='y' class='btn'></div>
    </div>
    <div id='select' class='btn'></div>
    <div id='start' class='btn'></div>
  </div>
  <img id='font' src="font.png" style='display: none'>
  <img id='sprites' src="sprites.png" style='display: none'>
</body>
</html>
